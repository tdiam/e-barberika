# Μετάβαση στο PostgreSQL από MySQL

Οι οδηγίες στο παρόν αφορούν χρήστες που έχουν ακολουθήσει την προηγούμενη έκδοση για MySQL των [οδηγιών εγκατάστασης](installation.md).


## Αιτία

Οι προδιαγραφές της εφαρμογής απαιτούν να μπορούμε να απαντήσουμε σε ερωτήματα του τύπου "δώσε μου τα καταστήματα σε ακτίνα X χιλιομέτρων από αυτό το σημείο".

Τα καταστήματα -βάσει προδιαγραφών- αποθηκεύονται στη βάση ως συντεταγμένες WGS84 (γεωγραφικό μήκος και πλάτος, πχ. `36.134892, 108.300293`). Άρα πρέπει κάπως να εφαρμόζουμε μία μετατροπή από το σφαιροειδές μοντέλο του WGS84 σε ένα επίπεδο, ώστε να υπολογιστεί η χιλιομετρική απόσταση.

Αν και υπάρχουν τέτοιοι τύποι υπολογισμού ([[1]](https://en.wikipedia.org/wiki/Haversine_formula), [[2]](https://en.wikipedia.org/wiki/Vincenty%27s_formulae)), αφενός αν επιλεχθούν θα πρέπει να υλοποιηθούν από εμάς, και αφετέρου θα υπάρχει σημαντικό κόστος στη βάση δεδομένων αφού θα πρέπει να επιστρέφονται όλα τα καταστήματα και να ελέγχονται ένα-ένα.

Η λύση είναι να χρησιμοποιήσουμε το extension [PostGIS](https://postgis.net) για το PostgreSQL και το [GeoDjango](https://docs.djangoproject.com/en/2.1/ref/contrib/gis/) για το Django.

Το PostGIS είναι το μόνο που υποστηρίζει την αυτόματη προβολή συντεταγμένων WGS84 στο επίπεδο, όταν πραγματοποιούνται σε αυτό ερωτήματα απόστασης σε μετρικό σύστημα. [[3]](https://docs.djangoproject.com/en/2.1/ref/contrib/gis/model-api/#geography-type).


## Οδηγίες για τη μεταφορά

> **ΠΡΟΣΟΧΗ:** Οι οδηγίες αφορούν μόνο το αρχικό στάδιο όπου δεν έχουμε εισάγει ακόμα δεδομένα στην εφαρμογή. Σε διαφορετική περίπτωση θα πρέπει να προβλεφθεί και η μεταφορά των δεδομένων από τη MySQL στη νέα βάση της PostgreSQL.

1. (Προαιρετικό) Διάγραψε τους χρήστες και τις βάσεις δεδομένων που περιείχε προηγουμένως η MySQL.
1. (Προαιρετικό) Απεγκατάστησε το Python module `mysqlclient`, καθώς δεν είναι πλέον απαραίτητο.
1. Ακολούθησε τα βήματα 1-6 στις [οδηγίες εγκατάστασης](installation.md).
1. Έχοντας ενεργοποιημένο το virtualenv, τρέξε την `pip install -e .[dev]` ώστε να εγκατασταθούν τα νέα απαραίτητα modules για το PostgreSQL.
1. Άλλαξε το `.env` ώστε να χρησιμοποιεί το PostGIS (`DATABASE_URL=postgis://asoures:<password>@localhost/asoures`).
1. Τρέξε `python manage.py migrate`.